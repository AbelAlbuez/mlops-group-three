<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palmer Penguins Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass-effect {
            backdrop-filter: blur(16px) saturate(180%);
            background-color: rgba(255, 255, 255, 0.75);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }

        .penguin-card {
            transition: all 0.3s ease;
        }

        .penguin-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="gradient-bg min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <h1 class="text-4xl font-bold text-white mb-4">
                <i class="fas fa-kiwi-bird mr-3"></i>
                Palmer Penguins Predictor
            </h1>
            <p class="text-white/80 text-lg">
                Predict penguin species using machine learning
            </p>
        </div>

        <!-- Main Card -->
        <div class="glass-effect rounded-2xl shadow-2xl p-8 fade-in">
            <form id="predictionForm" class="space-y-6">
                <!-- Input Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Bill Length -->
                    <div class="space-y-2">
                        <label for="billLength" class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-ruler mr-2 text-blue-500"></i>
                            Bill Length (mm)
                        </label>
                        <input type="number" id="billLength" name="bill_length_mm"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                            placeholder="e.g., 39.1" step="0.1" required>
                    </div>

                    <!-- Bill Depth -->
                    <div class="space-y-2">
                        <label for="billDepth" class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-arrows-alt-v mr-2 text-green-500"></i>
                            Bill Depth (mm)
                        </label>
                        <input type="number" id="billDepth" name="bill_depth_mm"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                            placeholder="e.g., 18.7" step="0.1" required>
                    </div>

                    <!-- Flipper Length -->
                    <div class="space-y-2">
                        <label for="flipperLength" class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-hand-paper mr-2 text-purple-500"></i>
                            Flipper Length (mm)
                        </label>
                        <input type="number" id="flipperLength" name="flipper_length_mm"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                            placeholder="e.g., 181" step="1" required>
                    </div>

                    <!-- Body Mass -->
                    <div class="space-y-2">
                        <label for="bodyMass" class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-weight mr-2 text-orange-500"></i>
                            Body Mass (g)
                        </label>
                        <input type="number" id="bodyMass" name="body_mass_g"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200"
                            placeholder="e.g., 3750" step="1" required>
                    </div>

                    <!-- Sex -->
                    <div class="space-y-2">
                        <label for="sex" class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-venus-mars mr-2 text-pink-500"></i>
                            Sex
                        </label>
                        <select id="sex" name="sex"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200"
                            required>
                            <option value="">Select sex</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>

                    <!-- Island -->
                    <div class="space-y-2">
                        <label for="island" class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-island-tropical mr-2 text-teal-500"></i>
                            Island
                        </label>
                        <select id="island" name="island"
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200"
                            required>
                            <option value="">Select island</option>
                            <option value="Biscoe">Biscoe</option>
                            <option value="Dream">Dream</option>
                            <option value="Torgersen">Torgersen</option>
                        </select>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-6">
                    <button type="submit" id="submitBtn"
                        class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                        <span id="submitText">
                            <i class="fas fa-magic mr-2"></i>
                            Predict Species
                        </span>
                        <span id="loadingText" class="hidden">
                            <i class="fas fa-spinner loading mr-2"></i>
                            Predicting...
                        </span>
                    </button>
                </div>
            </form>

            <!-- Model Selection -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <label for="modelSelect" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-brain mr-2 text-indigo-500"></i>
                    Select Model
                </label>
                <select id="modelSelect" 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="rf">Random Forest</option>
                    <option value="knn">K-Nearest Neighbors</option>
                    <option value="svm">Support Vector Machine</option>
                </select>
            </div>

            <!-- Results Section -->
            <div id="results" class="hidden mt-8 p-6 bg-white rounded-xl border border-gray-200 shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-chart-line mr-2 text-green-500"></i>
                    Prediction Results
                </h3>
                <div id="predictionResult" class="space-y-4">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Error Section -->
            <div id="errorSection" class="hidden mt-8 p-6 bg-red-50 rounded-xl border border-red-200">
                <h3 class="text-xl font-semibold text-red-800 mb-4">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    Error
                </h3>
                <div id="errorMessage" class="text-red-700">
                    <!-- Error message will be populated here -->
                </div>
            </div>
        </div>

        <!-- Species Info Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="penguin-card glass-effect rounded-xl p-6 text-center">
                <div class="text-4xl mb-4">üêß</div>
                <h3 class="font-semibold text-gray-800 mb-2">Adelie</h3>
                <p class="text-sm text-gray-600">Most common penguin species in the dataset</p>
            </div>
            <div class="penguin-card glass-effect rounded-xl p-6 text-center">
                <div class="text-4xl mb-4">üêß</div>
                <h3 class="font-semibold text-gray-800 mb-2">Chinstrap</h3>
                <p class="text-sm text-gray-600">Distinctive black marking under head</p>
            </div>
            <div class="penguin-card glass-effect rounded-xl p-6 text-center">
                <div class="text-4xl mb-4">üêß</div>
                <h3 class="font-semibold text-gray-800 mb-2">Gentoo</h3>
                <p class="text-sm text-gray-600">Largest of the three species</p>
            </div>
        </div>
    </div>

    <script>
        // Load available models on page load
        window.addEventListener('load', async function() {
            try {
                const response = await fetch('/models');
                const data = await response.json();
                console.log('Available models:', data.available);
            } catch (error) {
                console.log('Could not load model info:', error);
            }
        });

        document.getElementById('predictionForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            const results = document.getElementById('results');
            const errorSection = document.getElementById('errorSection');
            const predictionResult = document.getElementById('predictionResult');
            const errorMessage = document.getElementById('errorMessage');

            // Show loading state
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            loadingText.classList.remove('hidden');
            results.classList.add('hidden');
            errorSection.classList.add('hidden');

            // Collect form data
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            // Convert numeric fields and prepare data for API
            const requestData = {
                bill_length_mm: parseFloat(data.bill_length_mm),
                bill_depth_mm: parseFloat(data.bill_depth_mm),
                flipper_length_mm: parseInt(data.flipper_length_mm),
                body_mass_g: parseInt(data.body_mass_g),
                sex: data.sex,
                island: data.island,
                year: 2008 // Default year as shown in smoke_test.py
            };

            const selectedModel = document.getElementById('modelSelect').value;

            try {
                // First, select the model if it's different from the current one
                if (selectedModel) {
                    await fetch(`/models/select/${selectedModel}`, {
                        method: 'POST'
                    });
                }

                // Make prediction request
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                displayResults(result, requestData);

            } catch (error) {
                console.error('Error:', error);
                displayError(error.message);
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                loadingText.classList.add('hidden');
            }
        });

        function displayError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.innerHTML = `
                <div class="p-4 bg-red-100 rounded-lg">
                    <p class="font-semibold">Prediction failed:</p>
                    <p class="mt-2 text-sm">${message}</p>
                    <p class="mt-2 text-xs text-red-600">Please check your input values and try again.</p>
                </div>
            `;
            
            errorSection.classList.remove('hidden');
            errorSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayResults(result, inputData) {
            const predictionResult = document.getElementById('predictionResult');
            const results = document.getElementById('results');

            const speciesEmoji = {
                'Adelie': 'üêß',
                'Chinstrap': 'üêß',
                'Gentoo': 'üêß'
            };

            const speciesColor = {
                'Adelie': 'text-blue-600',
                'Chinstrap': 'text-green-600',
                'Gentoo': 'text-purple-600'
            };

            // Get the highest probability for confidence
            let confidence = 0;
            let probsHtml = '';
            
            if (result.probs && Object.keys(result.probs).length > 0) {
                confidence = Math.max(...Object.values(result.probs));
                
                // Create probability bars
                probsHtml = `
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm font-medium text-gray-700 mb-3">Class Probabilities:</p>
                        <div class="space-y-2">
                `;
                
                for (const [species, prob] of Object.entries(result.probs)) {
                    const percentage = (prob * 100).toFixed(1);
                    const isWinner = prob === confidence;
                    const barColor = isWinner ? 'bg-green-500' : 'bg-gray-300';
                    const textColor = isWinner ? 'font-bold text-green-700' : 'text-gray-600';
                    
                    probsHtml += `
                        <div class="flex items-center justify-between">
                            <span class="text-sm ${textColor} w-20">${species}</span>
                            <div class="flex-1 mx-3 bg-gray-200 rounded-full h-2">
                                <div class="${barColor} h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-sm ${textColor} w-12 text-right">${percentage}%</span>
                        </div>
                    `;
                }
                
                probsHtml += `
                        </div>
                    </div>
                `;
            } else {
                confidence = 0.95; // Fallback confidence
            }

            predictionResult.innerHTML = `
                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="text-3xl">${speciesEmoji[result.prediction] || 'üêß'}</span>
                        <div>
                            <p class="text-sm text-gray-600">Predicted Species</p>
                            <p class="text-xl font-bold ${speciesColor[result.prediction] || 'text-gray-800'}">${result.prediction}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Confidence</p>
                        <p class="text-lg font-semibold text-gray-800">${(confidence * 100).toFixed(1)}%</p>
                    </div>
                </div>
                ${probsHtml}
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">Model Used</p>
                        <p class="font-medium">${result.model || 'Unknown'}</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">Prediction Time</p>
                        <p class="font-medium">${new Date().toLocaleTimeString()}</p>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm text-gray-600 mb-2">Input Parameters:</p>
                    <div class="text-xs text-gray-700 grid grid-cols-2 gap-2">
                        <div>Bill Length: ${inputData.bill_length_mm}mm</div>
                        <div>Bill Depth: ${inputData.bill_depth_mm}mm</div>
                        <div>Flipper Length: ${inputData.flipper_length_mm}mm</div>
                        <div>Body Mass: ${inputData.body_mass_g}g</div>
                        <div>Sex: ${inputData.sex}</div>
                        <div>Island: ${inputData.island}</div>
                    </div>
                </div>
            `;

            results.classList.remove('hidden');
            results.scrollIntoView({ behavior: 'smooth' });
        }

        // Model selection handler
        document.getElementById('modelSelect').addEventListener('change', async function() {
            const selectedModel = this.value;
            try {
                const response = await fetch(`/models/select/${selectedModel}`, {
                    method: 'POST'
                });
                if (response.ok) {
                    console.log(`Switched to model: ${selectedModel}`);
                }
            } catch (error) {
                console.error('Error switching model:', error);
            }
        });

        // Add some interactive animations
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('focus', function () {
                this.parentElement.style.transform = 'scale(1.02)';
            });

            element.addEventListener('blur', function () {
                this.parentElement.style.transform = 'scale(1)';
            });
        });

        // Pre-fill form with example data for testing
        function fillExampleData() {
            document.getElementById('billLength').value = 44.5;
            document.getElementById('billDepth').value = 17.1;
            document.getElementById('flipperLength').value = 200;
            document.getElementById('bodyMass').value = 4200;
            document.getElementById('sex').value = 'male';
            document.getElementById('island').value = 'Biscoe';
        }

        // Add example data button (for testing)
        window.addEventListener('load', function() {
            const form = document.getElementById('predictionForm');
            const exampleBtn = document.createElement('button');
            exampleBtn.type = 'button';
            exampleBtn.className = 'text-sm text-blue-600 hover:text-blue-800 underline mt-2';
            exampleBtn.innerHTML = 'üìù Fill with example data';
            exampleBtn.onclick = fillExampleData;
            form.appendChild(exampleBtn);
        });
    </script>
</body>

</html>