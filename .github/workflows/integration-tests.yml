name: Integration Tests

on:
  workflow_run:
    workflows: ["Release Workflow"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL'
        required: false
        default: 'http://10.43.100.80:8001'
      streamlit_url:
        description: 'Streamlit URL'
        required: false
        default: 'http://10.43.100.80:8003'
      airflow_url:
        description: 'Airflow URL'
        required: false
        default: 'http://10.43.100.80:8080'
      mlflow_url:
        description: 'MLflow URL'
        required: false
        default: 'http://10.43.100.80:8020'
      grafana_url:
        description: 'Grafana URL'
        required: false
        default: 'http://10.43.100.87:3010'

permissions:
  contents: read
  actions: read

env:
  API_URL: ${{ github.event.inputs.api_url || 'http://10.43.100.80:8001' }}
  STREAMLIT_URL: ${{ github.event.inputs.streamlit_url || 'http://10.43.100.80:8003' }}
  AIRFLOW_URL: ${{ github.event.inputs.airflow_url || 'http://10.43.100.80:8080' }}
  MLFLOW_URL: ${{ github.event.inputs.mlflow_url || 'http://10.43.100.80:8020' }}
  GRAFANA_URL: ${{ github.event.inputs.grafana_url || 'http://10.43.100.87:3010' }}

jobs:
  wait-for-deployment:
    name: Wait for Argo CD Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment
        run: |
          echo "Waiting 2 minutes for Argo CD to deploy new release..."
          sleep 120
          echo "Deployment wait completed"

  test-infrastructure:
    name: Test Infrastructure Services
    runs-on: ubuntu-latest
    needs: wait-for-deployment
    steps:
      - name: Test Airflow
        run: |
          echo "Testing Airflow connection..."
          if curl -f -s -o /dev/null -w "%{http_code}" "${{ env.AIRFLOW_URL }}/health" | grep -q "200\|302"; then
            echo "✅ Airflow is accessible"
          else
            echo "❌ Airflow is not accessible"
            exit 1
          fi

      - name: Test MLflow
        run: |
          echo "Testing MLflow connection..."
          if curl -f -s -o /dev/null -w "%{http_code}" "${{ env.MLFLOW_URL }}" | grep -q "200\|302"; then
            echo "✅ MLflow is accessible"
          else
            echo "❌ MLflow is not accessible"
            exit 1
          fi

      - name: Test Grafana
        run: |
          echo "Testing Grafana connection..."
          if curl -f -s -o /dev/null -w "%{http_code}" "${{ env.GRAFANA_URL }}/api/health" | grep -q "200"; then
            echo "✅ Grafana is accessible"
          else
            echo "⚠️  Grafana health endpoint not available, trying main page..."
            if curl -f -s -o /dev/null -w "%{http_code}" "${{ env.GRAFANA_URL }}" | grep -q "200\|302"; then
              echo "✅ Grafana is accessible"
            else
              echo "❌ Grafana is not accessible"
              exit 1
            fi
          fi

  test-api:
    name: Test API Endpoints
    runs-on: ubuntu-latest
    needs: wait-for-deployment
    steps:
      - name: Test /health endpoint
        run: |
          echo "Testing /health endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "${{ env.API_URL }}/health")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ /health returned 200"
            echo "Response: $BODY"
          else
            echo "❌ /health returned $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Test /model-info endpoint
        run: |
          echo "Testing /model-info endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "${{ env.API_URL }}/model-info")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ /model-info returned 200"
            echo "Response: $BODY"
          else
            echo "❌ /model-info returned $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Test /predict endpoint
        run: |
          echo "Testing /predict endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ env.API_URL }}/predict" \
            -H "Content-Type: application/json" \
            -d '{
              "race": "Caucasian",
              "gender": "Female",
              "age_bucket": "[70-80)",
              "time_in_hospital": 3,
              "num_lab_procedures": 41,
              "num_procedures": 0,
              "num_medications": 11,
              "number_outpatient": 0,
              "number_emergency": 0,
              "number_inpatient": 0,
              "number_diagnoses": 6,
              "max_glu_serum": "None",
              "a1c_result": "None",
              "insulin": "Steady",
              "change_med": true,
              "diabetes_med": true,
              "diag_1": "428",
              "diag_2": "250.01",
              "diag_3": "401",
              "medical_specialty": "Cardiology",
              "admission_type_id": 1,
              "discharge_disposition_id": 1,
              "admission_source_id": 7
            }')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ /predict returned 200"
            echo "Response: $BODY"
          else
            echo "❌ /predict returned $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Test /metrics endpoint
        run: |
          echo "Testing /metrics endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "${{ env.API_URL }}/metrics")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ /metrics returned 200"
            echo "Metrics endpoint is accessible"
          else
            echo "❌ /metrics returned $HTTP_CODE"
            exit 1
          fi

  test-streamlit:
    name: Test Streamlit UI
    runs-on: ubuntu-latest
    needs: wait-for-deployment
    steps:
      - name: Test Streamlit accessibility
        run: |
          echo "Testing Streamlit UI..."
          if curl -f -s -o /dev/null -w "%{http_code}" "${{ env.STREAMLIT_URL }}" | grep -q "200"; then
            echo "✅ Streamlit UI is accessible"
          else
            echo "❌ Streamlit UI is not accessible"
            exit 1
          fi

      - name: Test Streamlit health
        run: |
          echo "Testing Streamlit health endpoint..."
          if curl -f -s "${{ env.STREAMLIT_URL }}/_stcore/health" | grep -q "ok\|healthy"; then
            echo "✅ Streamlit health check passed"
          else
            echo "⚠️  Streamlit health endpoint not available, but UI is accessible"
          fi

  e2e-test:
    name: End-to-End Test
    runs-on: ubuntu-latest
    needs: [test-api, test-streamlit]
    steps:
      - name: Run E2E prediction workflow
        run: |
          echo "Running E2E test: Full prediction workflow..."
          
          # Step 1: Check API health
          echo "Step 1: Checking API health..."
          API_HEALTH=$(curl -s "${{ env.API_URL }}/health")
          if echo "$API_HEALTH" | grep -q "healthy\|ok"; then
            echo "✅ API is healthy"
          else
            echo "❌ API health check failed"
            exit 1
          fi
          
          # Step 2: Get model info
          echo "Step 2: Getting model info..."
          MODEL_INFO=$(curl -s "${{ env.API_URL }}/model-info")
          if echo "$MODEL_INFO" | grep -q "model_name\|version"; then
            echo "✅ Model info retrieved"
            echo "$MODEL_INFO"
          else
            echo "❌ Failed to get model info"
            exit 1
          fi
          
          # Step 3: Make prediction
          echo "Step 3: Making prediction..."
          PREDICTION=$(curl -s -X POST "${{ env.API_URL }}/predict" \
            -H "Content-Type: application/json" \
            -d '{
              "race": "Caucasian",
              "gender": "Female",
              "age_bucket": "[70-80)",
              "time_in_hospital": 3,
              "num_lab_procedures": 41,
              "num_procedures": 0,
              "num_medications": 11,
              "number_outpatient": 0,
              "number_emergency": 0,
              "number_inpatient": 0,
              "number_diagnoses": 6,
              "max_glu_serum": "None",
              "a1c_result": "None",
              "insulin": "Steady",
              "change_med": true,
              "diabetes_med": true,
              "diag_1": "428",
              "diag_2": "250.01",
              "diag_3": "401",
              "medical_specialty": "Cardiology",
              "admission_type_id": 1,
              "discharge_disposition_id": 1,
              "admission_source_id": 7
            }')
          
          if echo "$PREDICTION" | grep -q "prediction\|probability"; then
            echo "✅ Prediction successful"
            echo "$PREDICTION"
          else
            echo "❌ Prediction failed"
            echo "$PREDICTION"
            exit 1
          fi
          
          # Step 4: Verify Streamlit is accessible
          echo "Step 4: Verifying Streamlit UI..."
          if curl -f -s -o /dev/null "${{ env.STREAMLIT_URL }}"; then
            echo "✅ Streamlit UI is accessible"
          else
            echo "❌ Streamlit UI check failed"
            exit 1
          fi
          
          echo "✅ E2E test completed successfully"

  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: test-api
    steps:
      - name: Install bc for calculations
        run: |
          sudo apt-get update && sudo apt-get install -y bc

      - name: Run performance test
        id: perf_test
        run: |
          echo "Running performance test: 10 requests to /predict endpoint..."
          
          TOTAL_TIME=0
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          for i in {1..10}; do
            echo "Request $i/10..."
            START_TIME=$(date +%s.%N)
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ env.API_URL }}/predict" \
              -H "Content-Type: application/json" \
              -d '{
                "race": "Caucasian",
                "gender": "Female",
                "age_bucket": "[70-80)",
                "time_in_hospital": 3,
                "num_lab_procedures": 41,
                "num_procedures": 0,
                "num_medications": 11,
                "number_outpatient": 0,
                "number_emergency": 0,
                "number_inpatient": 0,
                "number_diagnoses": 6,
                "max_glu_serum": "None",
                "a1c_result": "None",
                "insulin": "Steady",
                "change_med": true,
                "diabetes_med": true,
                "diag_1": "428",
                "diag_2": "250.01",
                "diag_3": "401",
                "medical_specialty": "Cardiology",
                "admission_type_id": 1,
                "discharge_disposition_id": 1,
                "admission_source_id": 7
              }')
            
            END_TIME=$(date +%s.%N)
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            ELAPSED=$(echo "$END_TIME - $START_TIME" | bc)
            
            if [ "$HTTP_CODE" = "200" ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              TOTAL_TIME=$(echo "$TOTAL_TIME + $ELAPSED" | bc)
              echo "  ✅ Request $i: ${ELAPSED}s"
            else
              FAIL_COUNT=$((FAIL_COUNT + 1))
              echo "  ❌ Request $i: Failed (HTTP $HTTP_CODE)"
            fi
          done
          
          if [ $SUCCESS_COUNT -gt 0 ]; then
            AVG_TIME=$(echo "scale=3; $TOTAL_TIME / $SUCCESS_COUNT" | bc)
            echo ""
            echo "Performance Results:"
            echo "  Successful requests: $SUCCESS_COUNT/10"
            echo "  Failed requests: $FAIL_COUNT/10"
            echo "  Average response time: ${AVG_TIME}s"
            
            echo "avg_time=$AVG_TIME" >> $GITHUB_OUTPUT
            echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
            echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
            
            # Performance criteria
            if (( $(echo "$AVG_TIME < 1" | bc -l) )); then
              echo "  Status: ✅ Good (< 1s)"
              echo "status=good" >> $GITHUB_OUTPUT
            elif (( $(echo "$AVG_TIME <= 3" | bc -l) )); then
              echo "  Status: ⚠️  Acceptable (1-3s)"
              echo "status=acceptable" >> $GITHUB_OUTPUT
            else
              echo "  Status: ❌ Fail (> 3s)"
              echo "status=fail" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "❌ All requests failed"
            exit 1
          fi

  generate-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [test-infrastructure, test-api, test-streamlit, e2e-test, performance-test]
    if: always()
    steps:
      - name: Generate comprehensive report
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Integration Tests Report
          
          ## Test Results Summary
          
          | Test Suite | Status |
          |------------|--------|
          | Infrastructure | ${{ needs.test-infrastructure.result == 'success' && '✅ Pass' || '❌ Fail' }} |
          | API Endpoints | ${{ needs.test-api.result == 'success' && '✅ Pass' || '❌ Fail' }} |
          | Streamlit UI | ${{ needs.test-streamlit.result == 'success' && '✅ Pass' || '❌ Fail' }} |
          | E2E Test | ${{ needs.e2e-test.result == 'success' && '✅ Pass' || '❌ Fail' }} |
          | Performance | ${{ needs.performance-test.result == 'success' && '✅ Pass' || '❌ Fail' }} |
          
          ## Test URLs
          
          - **API**: ${{ env.API_URL }}
          - **Streamlit**: ${{ env.STREAMLIT_URL }}
          - **Airflow**: ${{ env.AIRFLOW_URL }}
          - **MLflow**: ${{ env.MLFLOW_URL }}
          - **Grafana**: ${{ env.GRAFANA_URL }}
          
          ## Performance Metrics
          
          - **Average Response Time**: ${{ needs.performance-test.outputs.avg_time || 'N/A' }}s
          - **Success Rate**: ${{ needs.performance-test.outputs.success_count || '0' }}/10 requests
          - **Status**: ${{ needs.performance-test.outputs.status || 'N/A' }}
          
          ## Overall Status
          
          ${{ needs.test-infrastructure.result == 'success' && needs.test-api.result == 'success' && needs.test-streamlit.result == 'success' && needs.e2e-test.result == 'success' && needs.performance-test.result == 'success' && '✅ **All tests passed!**' || '❌ **Some tests failed. Please review the logs above.**' }}
          
          ---
          
          *Report generated automatically after release deployment*
          EOF

